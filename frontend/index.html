<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lang Chain powered + RAG + Ollama Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4">Lang Chain powered + RAG + Ollama Chat</h2>

        <div class="mb-3">
            <textarea id="userQuery" class="form-control" rows="3" placeholder="Type your question here..."></textarea>
        </div>
        <button id="sendBtn" class="btn btn-primary mb-4">Send</button>

        <div id="chatArea">
            <!-- Chat messages will appear here -->
        </div>
    </div>

    <script>
        const sendBtn = document.getElementById("sendBtn");
        const userQuery = document.getElementById("userQuery");
        const chatArea = document.getElementById("chatArea");

        function addMessage(text, sender="user") {
            const div = document.createElement("div");
            div.classList.add("mb-3", "p-2", "rounded");
            div.style.backgroundColor = sender === "user" ? "#d1e7dd" : "#f8d7da";
            div.innerHTML = `<strong>${sender === "user" ? "You" : "AI"}:</strong> ${text}`;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        sendBtn.addEventListener("click", async () => {
            const q = userQuery.value.trim();
            if (!q) return;

            addMessage(q, "user");
            userQuery.value = "";
            addMessage("Thinking...", "ai");

            try {
                const res = await fetch("http://127.0.0.1:5000/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ q })
                });
                const data = await res.json();

                // Remove the "Thinking..." message
                chatArea.lastChild.remove();

                if (data.answer) {
                    addMessage(data.answer, "ai");
                } else {
                    addMessage("No answer returned.", "ai");
                }

                // Optional: show retrieved chunks
                if (data.retrieved && data.retrieved.length > 0) {
                    const recDiv = document.createElement("div");
                    recDiv.classList.add("mb-3", "p-2", "rounded", "bg-light");
                    recDiv.style.border = "1px dashed #ccc";
                    recDiv.innerHTML = `<strong>Retrieved Chunks:</strong><br>${data.retrieved.map(c => c.slice(0,200)+"...").join("<hr>")}`;
                    chatArea.appendChild(recDiv);
                }

            } catch (err) {
                console.error(err);
                chatArea.lastChild.remove();
                addMessage("Error connecting to server.", "ai");
            }
        });
    </script>
</body>
</html>
